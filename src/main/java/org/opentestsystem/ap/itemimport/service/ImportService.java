package org.opentestsystem.ap.itemimport.service;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.gitlab4j.api.utils.FileUtils;
import org.opentestsystem.ap.itemimport.config.AppProps;
import org.opentestsystem.ap.itemimport.config.ApplicationDependencyProvider;
import org.opentestsystem.ap.itemimport.model.report.ImportReport;
import org.opentestsystem.ap.itemimport.model.report.ImportResult;
import org.opentestsystem.ap.itemimport.repository.ReportRepository;
import org.opentestsystem.ap.itemimport.util.ImportFileUtil;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.nio.file.Path;
import java.util.List;
import java.util.concurrent.CompletableFuture;
import java.util.stream.Collectors;

@Slf4j
@Component
public class ImportService {

    private final AppProps appProps;

    private final ImportServiceValidator importValidator;

    private final ReportRepository reportRepository;

    private final AsyncImportService asyncImportService;

    public ImportService(final ApplicationDependencyProvider dependencyProvider,
                         final ImportServiceValidator importValidator,
                         final ReportRepository reportRepository,
                         final AsyncImportService asyncService) {
        this.appProps = dependencyProvider.getAppProps();
        this.importValidator = importValidator;
        this.reportRepository = reportRepository;
        this.asyncImportService = asyncService;
    }

    /**
     * Main item import process
     */
    public void importItems() {
        ImportReport importReport = new ImportReport();
        importReport.startTimer();

        List<String> itemsToImport = ImportFileUtil.fileToCollection(this.appProps.getImportIdFile());

        final List<CompletableFuture<ImportResult>> futuresList = itemsToImport
                .stream().map(item -> asyncImportService.importItemAsync(item)).collect(Collectors.toList());

        importReport.getImportResults().addAll(futuresList.stream().map(CompletableFuture::join).collect(Collectors.toList()));

        importReport.stopTimer();

        importReport.setAppProps(appProps);

        if (appProps.isPublishReportEnabled()) {
            Path reportPath = reportRepository.publishReport(importReport);
            logReport(reportPath);
        }
    }

    private void logReport(final Path file) {
        try {
            final String reportString = FileUtils.readFileContents(file.toFile());
            log.info("\r\n{}", reportString);
        } catch (IOException e) {
            log.warn("unable to log report file {} - ", file, ExceptionUtils.getRootCauseMessage(e));
        }
    }

    public void validateProps() {
        importValidator.validateProps(appProps);
    }

    public List<String> currentPropsList() {
        return importValidator.currentPropsList(appProps);
    }

}