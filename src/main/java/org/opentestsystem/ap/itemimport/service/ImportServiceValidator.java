package org.opentestsystem.ap.itemimport.service;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.filefilter.WildcardFileFilter;
import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.ap.common.exception.ValidationException;
import org.opentestsystem.ap.itemimport.config.AppProps;
import org.springframework.stereotype.Component;

import java.io.File;
import java.nio.file.Files;
import java.nio.file.Paths;

@Component
public class ImportServiceValidator {

    /**
     * Validates that all properties are valid to begin processing
     * @param props
     */

    public void validateProps(AppProps props) {

        final String APP_PROPERTIES_EMPTY = "Application properties are empty";

        final String SOURCE_DIR_NOT_PROVIDED = "Source directory is required";

        final String SOURCE_DIR_NOT_EXISTS = "Source directory does not exist";

        final String SOURCE_FILE_EXTENSION = "*.*";

        final String SOURCE_DIR_NO_IMPORT_FILES = "Source directory contains no files";

        final String GL_GROUP_EMPTY = "Destination Gitlab group is required";

        final String INCLUDE_FILE_NOT_PROVIDED = "Include file is required";

        final String INCLUDE_FILE_NOT_EXISTS = "Include file does not exist";

        final String INCLUDE_FILE_EMPTY = "Include file is empty";

        final String EXCLUDE_FILE_NOT_EXISTS = "Exclude file does not exist";

        final String EXCLUDE_FILE_EMPTY = "Exclude file is empty";

        /*-----------------------------------------------------------------------------*/

        if (props == null) {
            throw new ValidationException(APP_PROPERTIES_EMPTY);
        }

        if (StringUtils.isBlank(props.getSourceDir())) {
            throw new ValidationException(SOURCE_DIR_NOT_PROVIDED);
        }

        if (!Files.isDirectory(Paths.get(props.getSourceDir()))) {
            throw new ValidationException(SOURCE_DIR_NOT_EXISTS + ": " + props.getSourceDir());
        }

        File dir = new File(props.getSourceDir());
        if (dir.isDirectory()) {
            if (FileUtils.listFiles(dir, new WildcardFileFilter(SOURCE_FILE_EXTENSION), null).isEmpty()) {
                throw new ValidationException(SOURCE_DIR_NO_IMPORT_FILES);
            }
        }

        if (StringUtils.isBlank(props.getIncludeFile())) {
            throw new ValidationException(INCLUDE_FILE_NOT_PROVIDED);
        } else {
            File f = new File(props.getIncludeFile());
            if (!f.exists()) {
                throw new ValidationException(INCLUDE_FILE_NOT_EXISTS);
            } else {
                if (f.length() == 0) {
                    throw  new ValidationException(INCLUDE_FILE_EMPTY);
                }
            }
        }

        if (StringUtils.isNotBlank(props.getExcludeFile())) {
            File f = new File(props.getIncludeFile());
            if (!f.exists()) {
                throw new ValidationException(EXCLUDE_FILE_NOT_EXISTS);
            } else {
                if (f.length() == 0) {
                    throw  new ValidationException(EXCLUDE_FILE_EMPTY);
                }
            }
        }
    }
}
