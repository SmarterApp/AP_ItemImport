package org.opentestsystem.ap.itemimport.mapper;

import lombok.NoArgsConstructor;
import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.ap.common.model.EqItem;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.ItemContext;
import org.opentestsystem.ap.common.model.Table;
import org.opentestsystem.ap.common.model.TiItem;
import org.opentestsystem.ap.common.repository.RepositoryUtil;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.common.saaif.wordlist.WordlistreleaseType;
import org.opentestsystem.ap.itemimport.model.IatMappingResult;
import org.opentestsystem.ap.itemimport.util.ImportFileUtil;
import org.opentestsystem.ap.itemimport.util.ImportMapperUtil;

import java.io.File;
import java.util.ArrayList;
import java.util.List;

@NoArgsConstructor
public class TiModelMapper extends IatModelMapper {

    @Override
    Item mapContent(Item item,
                    ItemRelease release,
                    ItemContext itemContext,
                    String itemSourceFullPath) {
        TiItem tiItem = (TiItem) item;
        String itemDestinationFullPath = itemContext.getLocalRepositoryPath().toString();

        IatMappingResult mappingResult = new IatMappingResult();
        for (ItemRelease.Item.Content content : release.getItem().getContent()) {
            if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ENU)) {
                mappingResult = mapTableInteractionContent(content, mappingResult);
                tiItem.getCore().getEn().setPrompt(mappingResult.getPrompt());

                tiItem.getCore().getEn().getTable().getColumns().clear();
                mappingResult.getHeaders().forEach(header ->
                    tiItem.getCore().getEn().getTable().getColumns()
                            .add(new Table.Column(header))
                );

                tiItem.getCore().getEn().getTable().getRows().clear();
                mappingResult.getRows().forEach(row -> {
                    List<String> values = (ArrayList<String>) row;
                    tiItem.getCore().getEn().getTable().getRows()
                            .add(processMappingRow(values));
                });

            } else if (content.getLanguage().equals(ItemConstants.ItemLanguage.LANG_ESN)) {
                mappingResult = mapTableInteractionContent(content, mappingResult);
                tiItem.getTranslations().getEsp().setPrompt(mappingResult.getPrompt());

                tiItem.getTranslations().getEsp().getTable().getColumns().clear();
                mappingResult.getHeaders().forEach(header ->
                        tiItem.getTranslations().getEsp().getTable().getColumns()
                                .add(new Table.Column(header))
                );

                tiItem.getTranslations().getEsp().getTable().getRows().clear();
                mappingResult.getRows().forEach(row -> {
                    List<String> values = (ArrayList<String>) row;
                    tiItem.getTranslations().getEsp().getTable().getRows()
                            .add(processMappingRow(values));
                });

            }
            // Process attachments
            processAttachments(content, tiItem, itemSourceFullPath, itemDestinationFullPath);
        }

        //Process Audio Resources
        processAudioResources(mappingResult, tiItem, itemSourceFullPath, itemDestinationFullPath);

        //Process Image Resources
        processImageResources(mappingResult, tiItem, itemSourceFullPath, itemDestinationFullPath);

        // Import Qrx file if present in import directory
        processMachineScoring(tiItem, release, itemSourceFullPath, itemDestinationFullPath);

        return tiItem;
    }

    private Table.Row processMappingRow(List<String> values) {
        Table.Row iatRow = new Table.Row();
        values.forEach(value-> {
            String cellType = "label";
            if (value.contains("data-its-validationrule")) {
                cellType = "answer";
            } else if (StringUtils.isNumeric(value)) {
                cellType = "answerNumeric";
            }
            Table.Cell cell = new Table.Cell(cellType, value);
            iatRow.addCell(cell);
        });

        return iatRow;
    }

    private void processMachineScoring(TiItem tiItem, ItemRelease release, String sourceDir, String destinationDir) {
        File qrxFile = ImportMapperUtil.getQrxFileFromItemRelease(release, sourceDir);
        if (null != qrxFile) {
            ImportFileUtil.copyFile(sourceDir + "/" + qrxFile.getName(),
                    destinationDir + "/" + RepositoryUtil.getQrxFileName(tiItem.getId(),
                            ItemConstants.ItemVersion.ITEM_VERSION));
            tiItem.getCore().getScoring().setManagedByIat(false);
        }
    }
}