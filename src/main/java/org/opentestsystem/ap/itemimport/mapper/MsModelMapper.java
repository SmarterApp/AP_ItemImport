package org.opentestsystem.ap.itemimport.mapper;

import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemContext;
import org.opentestsystem.ap.common.model.ItemOption;
import org.opentestsystem.ap.common.model.MsItem;
import org.opentestsystem.ap.common.saaif.item.ItemRelease;
import org.opentestsystem.ap.common.saaif.metadata.SmarterAppMetadata;
import org.opentestsystem.ap.itemimport.model.IATMappingResult;
import org.opentestsystem.ap.itemimport.util.ImportMapperUtil;
import org.opentestsystem.ap.itemimport.util.ItemFileUtil;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.concurrent.atomic.AtomicInteger;

public class MsModelMapper extends IatModelMapper {

    @Override
    Item mapContent(Item item, ItemRelease release, ItemContext itemContext, String itemSourceFullPath) {
        MsItem msItem = (MsItem) item;
        String itemDestinationFullPath = itemContext.getLocalRepositoryPath().toString();

        ItemRelease.Item.Attriblist.Attrib answerAttrib = release.getItem().getAttriblist()
                .getAttrib().stream()
                .filter(k -> "itm_att_Answer Key".equals(k.getAttid()))
                .findAny()
                .orElse(null);

        List<String> answers = new ArrayList<>();
        if (null != answerAttrib) {
            String[] values = answerAttrib.getVal().split(",");
            answers = new ArrayList<>(Arrays.asList(values));
        }

        IATMappingResult mappingResult = new IATMappingResult();
        for (ItemRelease.Item.Content content : release.getItem().getContent()) {
            // Call main IAT mapping function
            mappingResult = mapRichTextContent(content, mappingResult);

            if (content.getLanguage().equals("ENU")) {
                msItem.getCore().getEn().setPrompt(mappingResult.getContent());
                AtomicInteger index = new AtomicInteger(0);
                //Map Options Rationale
                for (ItemRelease.Item.Content.Rationaleoptlist.Rationale rationale : content.getRationaleoptlist().getRationale()) {
                    String optionValue = content.getOptionlist().getOption().get(index.get()).getVal();
                    String rationaleValue = rationale.getVal();
                    msItem.getCore().getEn().getOptions().add(
                            ItemOption.newItemOption(optionValue, "",
                                    answers.contains(ImportMapperUtil.getCharacterUsingIntValue(index.get())) , rationaleValue));
                    index.getAndIncrement();
                }
            } else if (content.getLanguage().equals("ESN")) {
                msItem.getTranslations().getEsp().setPrompt(mappingResult.getContent());
                AtomicInteger index = new AtomicInteger(0);
                //Map Options Rationale
                for (ItemRelease.Item.Content.Rationaleoptlist.Rationale rationale : content.getRationaleoptlist().getRationale()) {
                    String optionValue = content.getOptionlist().getOption().get(index.get()).getVal();
                    String rationaleValue = rationale.getVal();
                    msItem.getTranslations().getEsp().getOptions().add(
                            ItemOption.newItemOption(optionValue, "",
                                    answers.contains(ImportMapperUtil.getCharacterUsingIntValue(index.get())), rationaleValue));
                    index.getAndIncrement();
                }
            }

            // Process attachments
            if (content.getAttachmentlist() != null) {
                for (ItemRelease.Item.Content.Attachmentlist.Attachment attachment :
                        content.getAttachmentlist().getAttachment()) {
                    // TODO: Refactor logic below
                    if (attachment.getType().equals("ASL")) {
                        msItem.getAsl().getAttachments().add(createAttachment(attachment.getFile()));
                        ItemFileUtil.copyFile(itemSourceFullPath + "/" + attachment.getFile(),
                                itemDestinationFullPath + "/" + attachment.getFile());
                    } else if (attachment.getType().equals("BRF") || attachment.getType().equals("PRN")) {
                        msItem.getBraille().getAttachments().add(createAttachment(attachment.getFile()));
                        ItemFileUtil.copyFile(itemSourceFullPath + "/" + attachment.getFile(),
                                itemDestinationFullPath + "/" + attachment.getFile());
                    }
                }
            }
        }

        //Process Audio Resources
        mappingResult.getAudioSources().forEach(audio -> {
            msItem.getAudio().getAudioResources().add(createItemAudioResource(audio, audio.getAudioId()));
            audio.getSources().forEach(source -> {
                ItemFileUtil.copyFile(itemSourceFullPath + "/" + source,
                        itemDestinationFullPath + "/" + source);
            });
            if (StringUtils.isNotBlank(audio.getTrack())) {
                msItem.getCc().getAttachments().add(createAttachment(audio.getTrack()));
                msItem.getCc().getItemCcAudioAssociations().add(createItemCCAudioAssociation(audio.getTrack(), audio.getAudioId()));
                ItemFileUtil.copyFile(itemSourceFullPath + "/" + audio.getTrack(),
                        itemDestinationFullPath + "/" + audio.getTrack());
            }
        });

        //Process Image Resources
        mappingResult.getImageSources().forEach(image -> {
            //int imageId = resourceId.getAndIncrement();
            msItem.getImages().getImageResources().add(createItemImageResource(image.getSource(), image.getImageId()));
            ItemFileUtil.copyFile(itemSourceFullPath + "/" + image,
                    itemDestinationFullPath + "/" + image);
        });

        return msItem;
    }


    @Override
    Item mapMetadata(Item item, SmarterAppMetadata metadata) {
        MsItem msItem = (MsItem) item;
        msItem.getCore().setMetadata(mapItemMetadata(metadata));
        return msItem;
    }

    @Override
    Item mapAssociatedPassage(Item item, ItemRelease release) {
        MsItem msItem = (MsItem) item;
        if (StringUtils.isNotBlank(release.getItem().getAssociatedpassage())) {
            msItem.getCore().setStimulusId(release.getItem().getAssociatedpassage());
        }
        return msItem;
    }

    @Override
    Item mapTutorial(Item item, ItemRelease release) {
        MsItem msItem = (MsItem) item;
        if (StringUtils.isNotBlank(release.getItem().getTutorial().getId())) {
            msItem.getCore().setTutorialId(release.getItem().getTutorial().getId());
        }
        return msItem;
    }
}
