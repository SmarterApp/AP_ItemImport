package org.opentestsystem.ap.itemimport.repository;

import freemarker.template.Configuration;
import freemarker.template.TemplateExceptionHandler;
import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.assembler.StringAssembler;
import org.opentestsystem.ap.itemimport.config.AppProps;
import org.opentestsystem.ap.itemimport.config.ApplicationDependencyProvider;
import org.opentestsystem.ap.itemimport.model.report.ImportReport;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import static freemarker.template.Configuration.VERSION_2_3_25;

@Slf4j
@Component
public class ReportRepository {
    private static final String REPORT_FILE_NAME_PATTERN = "import-%1$tF-%1$tT.txt";

    private static final String REPORT_TEMPLATE = "import-report.ftl";

    private final AppProps appProps;

    private final StringAssembler reportAssembler;

    public ReportRepository(final ApplicationDependencyProvider dependencyProvider) {
        this.appProps = dependencyProvider.getAppProps();
        this.reportAssembler = newReportAssembler(this.appProps);
    }

    public String publishReport(final ImportReport report) {
        final String reportString = generateReport(report);
        try {
            Path file = Paths.get(appProps.getSourceDir() + "/"
                    + generateReportFileName(report.getReportDate()));

            Files.write(file, reportString.getBytes());
        } catch (IOException iox) {
            log.error("Unable to write Import report file. " + iox.getMessage());
        }
        return reportString;
    }

    // ------------------------------------------------------------------------

    private String generateReportFileName(final Date date) {
        return String.format(REPORT_FILE_NAME_PATTERN, date).replace(':', '_');
    }

    private String generateReport(final ImportReport report) {
        final Map<String, Object> input = new HashMap<>();
        input.put("report", report);

        return reportAssembler.generate(REPORT_TEMPLATE, input);
    }

    private StringAssembler newReportAssembler(final AppProps appProps) {
        final Configuration freemarkerConfig = new Configuration(VERSION_2_3_25);

        freemarkerConfig.setClassForTemplateLoading(this.getClass(), appProps.getReportTemplateFolder());

        freemarkerConfig.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
        freemarkerConfig.setDefaultEncoding("UTF-8");

        return new StringAssembler(freemarkerConfig);
    }
}
